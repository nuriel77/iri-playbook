[Unit]
Description=Nginx

[Service]
TimeoutStartSec=0
Restart=always
EnvironmentFile=-{{ config_dir }}/nginx
ExecStartPre=/usr/bin/bash -c "/usr/bin/systemctl set-environment SSL_CERTS_DIR=$(readlink -f /etc/ssl/certs)"
ExecStartPre=-/usr/bin/docker rm %p
ExecStart=/usr/bin/docker run \
  --name %p \
  --hostname %p \
  --net=host \
  --pid=host \
  -v /etc/localtime:/etc/localtime:ro,Z \
  -v /etc/nginx/nginx.conf:/etc/nginx/nginx.conf:ro,Z \
  -v /etc/ssl/private:/etc/ssl/private:ro,Z \
  -v ${SSL_CERTS_DIR}:/etc/ssl/certs:ro,Z \
  -v /etc/letsencrypt:/etc/letsencrypt:ro,Z \
  -v /etc/nginx/.htpasswd:/etc/nginx/.htpasswd:ro,Z \
  -v /etc/nginx/conf.d:/etc/nginx/conf.d:ro,Z \
  $DOCKER_OPTS \
  {{ nginx_image }}:${TAG}

ExecStop=/usr/bin/docker stop %p
ExecReload=/usr/bin/docker kill -s HUP %p

[Install]
WantedBy=multi-user.target
